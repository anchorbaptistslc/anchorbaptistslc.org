{{ $now := now }}
{{ $events := slice }}

{{/* Filter events to only include upcoming ones */}}
{{ if .Params.events }}
  {{ range .Params.events }}
    {{ $eventDate := time .date }}
    {{ $endDate := $eventDate }}
    {{ if .end_date }}
      {{ $endDate = time .end_date }}
    {{ end }}
    
    {{ if ge $endDate $now }}
      {{ $events = $events | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if gt (len $events) 0 }}
<div id="upcoming-events" class="py-12 bg-brand-light relative">
  <div class="container mx-auto px-4">
    <h2 class="text-3xl mb-6 text-center hero-heading text-brand-dark">Upcoming Events</h2>
    
    <div class="event-carousel relative">
      <div class="event-slides" data-current="0">
        {{ range $index, $event := $events }}
          {{ $eventDate := time .date }}
          {{ $endDate := $eventDate }}
          {{ if .end_date }}
            {{ $endDate = time .end_date }}
          {{ end }}
          
          <div class="event-slide {{ if eq $index 0 }}active{{ end }}" 
               data-event-date="{{ .date }}" 
               data-event-end="{{ with .end_date }}{{ . }}{{ else }}{{ .date }}{{ end }}">
            <div class="relative rounded-lg overflow-hidden shadow-lg">
              <div class="absolute inset-0">
                <img src="{{ partial "image.html" (dict "path" .image "width" "1200") }}" 
                     alt="{{ .title }}" 
                     class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-brand-dark bg-opacity-60"></div>
              </div>
              <div class="relative p-8 md:p-12 text-white">
                <div class="max-w-3xl mx-auto text-center">
                  <h3 class="text-3xl md:text-4xl font-bold mb-4">{{ .title }}</h3>
                  <p class="text-xl mb-4">{{ .description }}</p>
                  <p class="text-lg mb-6">
                    <span class="inline-block bg-brand-light text-brand-dark px-4 py-2 rounded-full">
                      {{ $eventDate.Format "Monday, January 2, 2006" }} at {{ $eventDate.Format "3:04 PM" }}
                    </span>
                  </p>
                  <a href="{{ .cta_url }}" class="inline-block bg-white text-brand-dark px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors duration-200">{{ .cta_text }}</a>
                </div>
              </div>
            </div>
          </div>
        {{ end }}
      </div>
      
      {{ if gt (len $events) 1 }}
      <div class="flex justify-center gap-2 mt-4">
        {{ range $index, $event := $events }}
        <button class="carousel-dot {{ if eq $index 0 }}active{{ end }}" data-slide="{{ $index }}">
          <span class="block w-3 h-3 rounded-full bg-gray-400 transition-colors"></span>
        </button>
        {{ end }}
      </div>
      
      <button class="carousel-nav prev absolute top-1/2 left-4 transform -translate-y-1/2 bg-white bg-opacity-80 rounded-full p-2 shadow-lg z-10 text-brand-dark hover:bg-opacity-100">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button class="carousel-nav next absolute top-1/2 right-4 transform -translate-y-1/2 bg-white bg-opacity-80 rounded-full p-2 shadow-lg z-10 text-brand-dark hover:bg-opacity-100">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      {{ end }}
    </div>
  </div>
</div>

{{/* Add JavaScript for event carousel and date-based visibility */}}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Event carousel functionality
  const carousel = document.querySelector('.event-carousel');
  if (!carousel) return;
  
  const slides = carousel.querySelector('.event-slides');
  const allSlides = carousel.querySelectorAll('.event-slide');
  const dots = carousel.querySelectorAll('.carousel-dot');
  const prevBtn = carousel.querySelector('.carousel-nav.prev');
  const nextBtn = carousel.querySelector('.carousel-nav.next');
  let currentSlide = 0;
  const slideCount = allSlides.length;
  
  function showSlide(index) {
    // Handle wrapping
    if (index >= slideCount) index = 0;
    if (index < 0) index = slideCount - 1;
    
    // Update current index
    currentSlide = index;
    slides.dataset.current = currentSlide;
    
    // Update slides
    allSlides.forEach((slide, i) => {
      slide.classList.toggle('active', i === currentSlide);
    });
    
    // Update dots
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === currentSlide);
      dot.querySelector('span').classList.toggle('bg-brand-dark', i === currentSlide);
      dot.querySelector('span').classList.toggle('bg-gray-400', i !== currentSlide);
    });
  }
  
  // Set up dot navigation
  dots.forEach(dot => {
    dot.addEventListener('click', () => {
      const slideIndex = parseInt(dot.dataset.slide);
      showSlide(slideIndex);
    });
  });
  
  // Set up arrow navigation
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      showSlide(currentSlide - 1);
    });
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      showSlide(currentSlide + 1);
    });
  }
  
  // Auto advance slides every 8 seconds if more than one
  if (slideCount > 1) {
    setInterval(() => {
      showSlide(currentSlide + 1);
    }, 8000);
  }
  
  // Check for expired events client-side
  const removeExpiredEvents = () => {
    let hasRemoved = false;
    const now = new Date();
    
    allSlides.forEach(slide => {
      try {
        const endDate = new Date(slide.dataset.eventEnd);
        if (endDate < now) {
          slide.style.display = 'none';
          hasRemoved = true;
        }
      } catch (e) {
        console.error('Error parsing date:', slide.dataset.eventEnd, e);
      }
    });
    
    // Hide entire section if all events expired
    if (hasRemoved && document.querySelectorAll('.event-slide:not([style*="display: none"])').length === 0) {
      document.getElementById('upcoming-events').style.display = 'none';
    }
  };
  
  // Check on load and periodically
  removeExpiredEvents();
  setInterval(removeExpiredEvents, 60000); // Check every minute
});
</script>

<style>
.event-slides {
  position: relative;
}

.event-slide {
  display: none;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.event-slide.active {
  display: block;
  opacity: 1;
}

.carousel-dot.active span {
  transform: scale(1.3);
}
</style>
{{ end }} 