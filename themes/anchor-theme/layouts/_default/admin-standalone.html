<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Manager for Anchor Theme</title>
    <style>
      /*
      Use anchor-theme brand-dark as the login page background color
      */
      [class*="StyledAuthenticationPage"] {
        background: #1a202c;
      }
    </style>
</head>
<body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Preview Templates -->
    <script>
      {{ if eq hugo.Environment "production" }}
        {{ $css := resources.Get "css/main.processed.css" | minify | fingerprint }}
        CMS.registerPreviewStyle("{{ $css.RelPermalink }}", { raw: false });
      {{ else }}
        {{ $css := resources.Get "css/main.css" }}
        {{ $opts := dict "inlineImports" true }}
        {{ $css = $css | css.PostCSS $opts }}
        CMS.registerPreviewStyle("{{ $css.RelPermalink }}", { raw: false });
      {{ end }}

      // Add Google Fonts
      CMS.registerPreviewStyle("https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300&family=Work+Sans:wght@400&display=swap", { raw: false });
      
      const HomePreview = createClass({
        getInitialState() {
          return { currentSlide: 0, events: [] };
        },
        
        componentDidMount() {
          try {
            // Fetch events from the Events collection using getCollection
            this.props.getCollection('events-items').then(events => {
              console.log('Events from getCollection:', events);
              
              // Filter for upcoming events
              const now = new Date();
              const upcomingEvents = events.filter(event => {
                // Log the event structure to understand it
                console.log('Event structure:', event);
                
                // Get the data from the event
                const eventData = event.get('data');
                console.log('Event data:', eventData);
                
                if (!eventData) return false;
                
                // Check if we have dates
                if (!eventData.dates) return false;
                
                // Get the end date or fall back to start date
                const endDate = eventData.dates.end ? new Date(eventData.dates.end) : 
                               (eventData.dates.start ? new Date(eventData.dates.start) : null);
                
                return endDate && endDate >= now;
              }).map(event => {
                const data = event.get('data');
                return {
                  ...data,
                  // Ensure dates are properly formatted
                  dates: {
                    start: data.dates?.start || null,
                    end: data.dates?.end || null
                  }
                };
              });
              
              // Sort events by start date
              upcomingEvents.sort((a, b) => {
                const aDate = a.dates && a.dates.start ? new Date(a.dates.start) : new Date(0);
                const bDate = b.dates && b.dates.start ? new Date(b.dates.start) : new Date(0);
                return aDate - bDate;
              });
              
              console.log('Upcoming events:', upcomingEvents);
              this.setState({ events: upcomingEvents });
            }).catch(error => {
              console.error('Error fetching events:', error);
            });
          } catch (error) {
            console.error('Error in componentDidMount:', error);
          }
        },
        
        nextSlide() {
          const activeEvents = this.getActiveEvents(this.state.events);
          
          this.setState(prevState => ({
            currentSlide: (prevState.currentSlide + 1) % activeEvents.length
          }));
        },
        
        prevSlide() {
          const activeEvents = this.getActiveEvents(this.state.events);
          
          this.setState(prevState => ({
            currentSlide: prevState.currentSlide === 0 
              ? activeEvents.length - 1 
              : prevState.currentSlide - 1
          }));
        },
        
        goToSlide(index) {
          this.setState({ currentSlide: index });
        },
        
        getActiveEvents(events) {
          const now = new Date();
          
          return events.filter(function(event) {
            try {
              const endDate = event.dates && event.dates.end ? new Date(event.dates.end) : 
                            (event.dates && event.dates.start ? new Date(event.dates.start) : null);
              return endDate && endDate >= now;
            } catch (e) {
              return false; 
            }
          });
        },
        
        render: function() {
          const entry = this.props.entry;
          const hero = entry.getIn(['data', 'hero']) ? entry.getIn(['data', 'hero']).toJS() : {};
          const worship = entry.getIn(['data', 'worship']) ? entry.getIn(['data', 'worship']).toJS() : {};
          const welcome = entry.getIn(['data', 'welcome']) ? entry.getIn(['data', 'welcome']).toJS() : {};
          const featured = entry.getIn(['data', 'featured']) ? entry.getIn(['data', 'featured']).toJS() : {};
          const params = entry.getIn(['data', 'params']) ? entry.getIn(['data', 'params']).toJS() : {};
          const events = this.state.events;
          
          // Get active events using the helper method
          const activeEvents = this.getActiveEvents(events);
          
          // Helper function to format dates
          const formatDate = function(dateString, endDateString) {
            if (!dateString) return 'Event Date';
            
            try {
              // If dateString is a Date object, get its ISO string
              if (typeof dateString === 'object' && dateString instanceof Date) {
                dateString = dateString.toISOString();
              }
              if (typeof endDateString === 'object' && endDateString instanceof Date) {
                endDateString = endDateString.toISOString();
              }
              
              // If we have both start and end dates, format as a range
              if (endDateString) {
                const startDate = new Date(dateString);
                const endDate = new Date(endDateString);
                
                // If dates are in different months or years, show full range
                const startMonth = startDate.getUTCMonth();
                const endMonth = endDate.getUTCMonth();
                const startYear = startDate.getUTCFullYear();
                const endYear = endDate.getUTCFullYear();
                
                // Format start date
                const formatOptions = { 
                  month: 'long',
                  day: 'numeric',
                  timeZone: 'UTC'
                };
                
                if (startYear !== endYear) {
                  // Different years: "January 1, 2025 - February 3, 2026"
                  formatOptions.year = 'numeric';
                  const startFormatted = new Intl.DateTimeFormat('en-US', formatOptions).format(startDate);
                  const endFormatted = new Intl.DateTimeFormat('en-US', Object.assign({}, formatOptions)).format(endDate);
                  return `${startFormatted} - ${endFormatted}`;
                } else if (startMonth !== endMonth) {
                  // Same year, different months: "January 30 - February 3, 2025"
                  const startFormatted = new Intl.DateTimeFormat('en-US', formatOptions).format(startDate);
                  const endFormatted = new Intl.DateTimeFormat('en-US', Object.assign({}, formatOptions, {year: 'numeric'})).format(endDate);
                  return `${startFormatted} - ${endFormatted}`;
                } else {
                  // Same month and year: "January 1-5, 2025"
                  const monthYear = new Intl.DateTimeFormat('en-US', {
                    month: 'long',
                    year: 'numeric',
                    timeZone: 'UTC'
                  }).format(startDate);
                  
                  const startDay = startDate.getUTCDate();
                  const endDay = endDate.getUTCDate();
                  
                  return `${monthYear.split(' ')[0]} ${startDay}-${endDay}, ${monthYear.split(' ')[1]}`;
                }
              } else {
                // For single day events, show full date and time
                const utcDate = new Date(dateString);
                
                // Format using Intl.DateTimeFormat with UTC timezone to preserve the time as entered
                const formatter = new Intl.DateTimeFormat('en-US', {
                  weekday: 'long',
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: 'numeric',
                  minute: 'numeric',
                  timeZone: 'UTC',
                  hour12: true
                });
                
                return formatter.format(utcDate);
              }
            } catch (e) {
              console.error('Error formatting date:', e);
              return String(dateString);
            }
          };
          
          return h('div', { className: 'bg-gray-50' },
            // Hero Section
            h('div', { className: 'relative overflow-hidden z-0' },
              h('div', { className: 'absolute inset-0' },
                h('img', {
                  src: hero.image ? this.props.getAsset(hero.image).toString() : '',
                  className: 'w-full h-full object-cover object-[center_65%]',
                  alt: '',
                  'aria-hidden': 'true'
                }),
                h('div', { className: 'absolute inset-0 bg-brand-dark bg-opacity-75 mix-blend-multiply transition-opacity duration-500 opacity-0' })
              ),
              h('div', { className: 'relative' },
                h('div', { className: 'container mx-auto px-4 py-24' },
                  h('div', { className: 'max-w-4xl' },
                    params.show_title && h('h1', { className: 'text-4xl md:text-5xl mb-6 text-white hero-heading' }, hero.title || ''),
                    h('p', { className: 'text-xl mb-8 text-white hero-tagline' }, hero.tagline || ''),
                    h('div', { className: 'space-x-4' },
                      hero.cta?.learn_more && h('a', {
                        href: hero.cta.learn_more.url || '#',
                        className: 'bg-white text-brand-dark px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 border-2 border-white'
                      }, hero.cta.learn_more.text || 'Learn More'),
                      hero.cta?.visit && h('a', {
                        href: hero.cta.visit.url || '#',
                        className: 'bg-transparent border-2 border-white text-white px-6 py-2 rounded-lg font-semibold transition-colors duration-200 hover:bg-gray-100 hover:text-brand-dark hover:border-gray-100'
                      }, hero.cta.visit.text || 'Visit Us')
                    )
                  )
                )
              )
            ),

            // Upcoming Events Section (if events exist)
            activeEvents.length > 0 && h('div', { className: 'py-12 bg-brand-light bg-opacity-80 relative shadow-lg' },
              h('div', { className: 'container mx-auto px-4' },
                // Show heading if show_heading is true or undefined
                (params.events_section?.show_heading !== false) && h('h2', { className: 'text-3xl mb-6 text-center hero-heading text-brand-dark' }, 
                  params.events_section?.heading || 'Upcoming Events'
                ),
                
                h('div', { className: 'event-carousel relative' },
                  // Show only the current event based on component state
                  activeEvents.length > 0 && h('div', { className: 'event-slide active' },
                    h('div', { className: 'relative rounded-lg overflow-hidden shadow-lg event-card' },
                      h('div', { className: 'absolute inset-0' },
                        h('img', {
                          src: activeEvents[this.state.currentSlide].image ? this.props.getAsset(activeEvents[this.state.currentSlide].image).toString() : '',
                          alt: activeEvents[this.state.currentSlide].title || '',
                          className: 'w-full h-full object-cover'
                        }),
                        h('div', { className: 'absolute inset-0 bg-brand-dark bg-opacity-40' })
                      ),
                      h('div', { className: 'relative p-4 md:p-6 text-white event-content' },
                        h('div', { className: 'max-w-3xl mx-auto text-center flex flex-col h-full mt-4 md:mt-8' },
                          h('div', { className: 'flex-grow' },
                            h('h3', { className: 'text-2xl md:text-3xl hero-heading mb-3' }, activeEvents[this.state.currentSlide].title || ''),
                            h('div', { className: 'event-description' },
                              h('p', { className: 'text-base hero-tagline' }, activeEvents[this.state.currentSlide].description || '')
                            ),
                            h('p', { className: 'text-lg mb-4' },
                              h('span', { className: 'inline-block bg-brand-light text-brand-dark px-3 py-1 rounded-full' },
                                formatDate(activeEvents[this.state.currentSlide].dates.start, activeEvents[this.state.currentSlide].dates.end)
                              )
                            )
                          ),
                          
                          // Indicator dots for navigation (centered at bottom)
                          activeEvents.length > 1 && h('div', { className: 'flex justify-center gap-2 mt-auto pb-2' },
                            activeEvents.map((_, index) => 
                              h('button', { 
                                key: index,
                                className: `w-2 h-2 rounded-full ${index === this.state.currentSlide ? 'bg-brand-dark' : 'bg-gray-400'} transition-colors`,
                                onClick: () => this.goToSlide(index)
                              })
                            )
                          )
                        )
                      )
                    )
                  ),
                  
                  // Left and right click areas for navigation (only if multiple events)
                  activeEvents.length > 1 && [
                    h('div', {
                      className: 'absolute inset-y-0 left-0 w-1/5 z-10 cursor-pointer',
                      onClick: this.prevSlide,
                      key: 'prev'
                    }),
                    h('div', {
                      className: 'absolute inset-y-0 right-0 w-1/5 z-10 cursor-pointer',
                      onClick: this.nextSlide,
                      key: 'next'
                    })
                  ]
                )
              )
            ),

            // Service Times
            h('div', { className: 'py-16 bg-white' },
              h('div', { className: 'container mx-auto px-4' },
                h('h2', { className: 'text-3xl mb-12 text-center hero-heading' }, worship.title || ''),
                h('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8' },
                  h('div', { className: 'text-center p-6 bg-gray-50 rounded-lg' },
                    h('h3', { className: 'font-medium mb-2 tracking-[0.05em]', style: { fontSize: '16px' } }, 'Sunday School'),
                    h('p', { className: 'text-xl text-brand-link' }, '9:30 AM')
                  ),
                  h('div', { className: 'text-center p-6 bg-gray-50 rounded-lg' },
                    h('h3', { className: 'font-medium mb-2 tracking-[0.05em]', style: { fontSize: '16px' } }, 'Sunday Morning'),
                    h('p', { className: 'text-xl text-brand-link' }, '10:45 AM')
                  ),
                  h('div', { className: 'text-center p-6 bg-gray-50 rounded-lg' },
                    h('h3', { className: 'font-medium mb-2 tracking-[0.05em]', style: { fontSize: '16px' } }, 'Sunday Evening'),
                    h('p', { className: 'text-xl text-brand-link' }, '6:00 PM')
                  ),
                  h('div', { className: 'text-center p-6 bg-gray-50 rounded-lg' },
                    h('h3', { className: 'font-medium mb-2 tracking-[0.05em]', style: { fontSize: '16px' } }, 'Wednesday'),
                    h('p', { className: 'text-xl text-brand-link' }, '7:00 PM')
                  )
                )
              )
            ),

            // Welcome Section
            h('div', { className: 'py-16 bg-white' },
              h('div', { className: 'container mx-auto px-4' },
                h('div', { className: 'lg:grid lg:grid-cols-2 lg:gap-8 lg:items-center' },
                  h('div', { className: 'prose' },
                    this.props.widgetFor('body')
                  ),
                  h('div', { className: 'mt-8 lg:mt-0' },
                    h('img', {
                      src: welcome.image ? this.props.getAsset(welcome.image).toString() : '',
                      alt: welcome.image_alt || '',
                      className: 'rounded-lg shadow-lg'
                    }),
                    welcome.image_alt && h('p', { className: 'mt-4 text-center text-gray-600' }, welcome.image_alt)
                  )
                )
              )
            ),

            // Featured Content
            featured.image && h('div', { className: 'relative py-16' },
              h('div', { className: 'absolute inset-0' },
                h('img', {
                  src: featured.image ? this.props.getAsset(featured.image).toString() : '',
                  alt: '',
                  className: 'w-full h-full object-cover',
                  'aria-hidden': 'true'
                }),
                h('div', { className: 'absolute inset-0 bg-gray-900 bg-opacity-60' })
              ),
              h('div', { className: 'container mx-auto px-4 relative' },
                h('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-8' },
                  featured.cards?.map(card => 
                    h('div', { key: card.title, className: 'bg-white bg-opacity-90 p-8 rounded-lg shadow-lg' },
                      h('h3', { className: 'text-2xl font-medium mb-4 tracking-[0.05em]' }, card.title || ''),
                      h('p', { className: 'mb-4' }, card.description || ''),
                      h('a', {
                        href: card.url || '#',
                        className: 'text-brand-link font-semibold hover:text-brand-linkHover'
                      }, card.link_text || 'Learn More →')
                    )
                  )
                )
              )
            )
          );
        }
      });

      const MinistryPreview = createClass({
        render: function() {
          const entry = this.props.entry;
          const data = entry.getIn(['data']).toJS();
          const contentImages = data.content_images || [];

          return h('div', { className: 'bg-white' },
            // Hero Section
            h('div', { className: 'relative h-48 md:h-64 overflow-hidden' },
              h('img', {
                src: data.featured_image ? this.props.getAsset(data.featured_image).toString() : '',
                className: 'absolute inset-0 w-full h-full object-cover',
                alt: data.title || ''
              }),
              h('div', { className: 'absolute inset-0 bg-gray-900 bg-opacity-60' }),
              h('div', { className: 'absolute inset-0 flex items-center' },
                h('div', { className: 'container mx-auto px-4' },
                  h('h1', { className: 'text-3xl md:text-4xl lg:text-5xl text-white mb-2 hero-heading' }, data.title || ''),
                  h('p', { className: 'text-lg md:text-xl text-white opacity-90 hero-tagline' }, data.tagline || '')
                )
              )
            ),
            // Content Section
            h('div', { className: 'container mx-auto px-4 py-8' },
              h('div', { className: 'flex flex-col lg:flex-row gap-8' },
                // Main Content
                h('div', { className: 'lg:w-7/12' },
                  // Quick Info Box
                  (data.meeting_time || data.location || data.age_group) && h('div', { className: 'bg-white rounded-lg shadow-sm p-6 mb-8' },
                    h('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6' },
                      data.meeting_time && h('div', null,
                        h('h3', { className: 'font-semibold text-gray-600 mb-1', style: { fontSize: 'inherit' } }, 'Meeting Time'),
                        h('p', { className: 'text-lg' }, data.meeting_time)
                      ),
                      data.location && h('div', null,
                        h('h3', { className: 'font-semibold text-gray-600 mb-1', style: { fontSize: 'inherit' } }, 'Location'),
                        h('p', { className: 'text-lg' }, data.location)
                      ),
                      data.age_group && h('div', null,
                        h('h3', { className: 'font-semibold text-gray-600 mb-1', style: { fontSize: 'inherit' } }, 'Age Group'),
                        h('p', { className: 'text-lg' }, data.age_group)
                      )
                    )
                  ),
                  // Main Content
                  h('div', { className: 'prose max-w-none' },
                    this.props.widgetFor('body')
                  ),
                  // Leaders Section
                  data.leaders && data.leaders.length > 0 && h('div', { className: 'mt-12' },
                    h('h2', { className: 'text-2xl font-medium mb-6' }, 'Ministry Leaders'),
                    h('div', { className: 'grid grid-cols-1 gap-8' },
                      data.leaders.map((leader, index) => 
                        h('div', { key: index, className: 'flex items-start space-x-4' },
                          leader.photo && h('img', {
                            src: this.props.getAsset(leader.photo).toString(),
                            alt: leader.name,
                            className: 'w-24 h-24 rounded-lg object-cover'
                          }),
                          h('div', null,
                            h('h3', { className: 'font-medium text-xl' }, leader.name),
                            leader.role && h('p', { className: 'text-gray-600 mb-2' }, leader.role),
                            leader.bio && h('p', { className: 'text-gray-700' }, leader.bio)
                          )
                        )
                      )
                    )
                  )
                ),
                // Images
                contentImages.length > 0 && h('div', { className: 'lg:w-5/12' },
                  h('div', { className: 'grid grid-cols-1 gap-8' },
                    contentImages.map((image, index) => 
                      h('div', { key: index, className: 'text-center' },
                        h('img', {
                          src: image.image ? this.props.getAsset(image.image).toString() : '',
                          alt: image.alt_text || '',
                          className: 'rounded-lg shadow-lg mb-4'
                        }),
                        image.caption && h('p', { className: 'text-gray-600' }, image.caption)
                      )
                    )
                  )
                )
              )
            )
          );
        }
      });

      CMS.registerPreviewTemplate('home', HomePreview);
      CMS.registerPreviewTemplate('plan-your-visit', MinistryPreview);
      CMS.registerPreviewTemplate('the-gospel', MinistryPreview);
      CMS.registerPreviewTemplate('ministries', MinistryPreview);
      CMS.registerPreviewTemplate('ministry-pages', MinistryPreview);
      CMS.registerPreviewTemplate('about', MinistryPreview); // Using same template as ministries since layout is similar
      CMS.registerPreviewTemplate('about-pages', MinistryPreview);
      
      // Event Preview Component
      const EventPreview = createClass({
        render: function() {
          const entry = this.props.entry;
          const data = entry.getIn(['data']) ? entry.getIn(['data']).toJS() : {};
          
          // Format dates
          const formatDate = function(dateString, endDateString) {
            if (!dateString) return '';
            
            try {
              // If dateString is a Date object, get its ISO string
              if (typeof dateString === 'object' && dateString instanceof Date) {
                dateString = dateString.toISOString();
              }
              if (typeof endDateString === 'object' && endDateString instanceof Date) {
                endDateString = endDateString.toISOString();
              }
              
              // If we have both start and end dates, format as a range
              if (endDateString) {
                const startDate = new Date(dateString);
                const endDate = new Date(endDateString);
                
                // If dates are in different months or years, show full range
                const startMonth = startDate.getUTCMonth();
                const endMonth = endDate.getUTCMonth();
                const startYear = startDate.getUTCFullYear();
                const endYear = endDate.getUTCFullYear();
                
                // Format start date
                const formatOptions = { 
                  month: 'long',
                  day: 'numeric',
                  timeZone: 'UTC'
                };
                
                if (startYear !== endYear) {
                  // Different years: "January 1, 2025 - February 3, 2026"
                  formatOptions.year = 'numeric';
                  const startFormatted = new Intl.DateTimeFormat('en-US', formatOptions).format(startDate);
                  const endFormatted = new Intl.DateTimeFormat('en-US', Object.assign({}, formatOptions)).format(endDate);
                  return `${startFormatted} - ${endFormatted}`;
                } else if (startMonth !== endMonth) {
                  // Same year, different months: "January 30 - February 3, 2025"
                  const startFormatted = new Intl.DateTimeFormat('en-US', formatOptions).format(startDate);
                  const endFormatted = new Intl.DateTimeFormat('en-US', Object.assign({}, formatOptions, {year: 'numeric'})).format(endDate);
                  return `${startFormatted} - ${endFormatted}`;
                } else {
                  // Same month and year: "January 1-5, 2025"
                  const monthYear = new Intl.DateTimeFormat('en-US', {
                    month: 'long',
                    year: 'numeric',
                    timeZone: 'UTC'
                  }).format(startDate);
                  
                  const startDay = startDate.getUTCDate();
                  const endDay = endDate.getUTCDate();
                  
                  return `${monthYear.split(' ')[0]} ${startDay}-${endDay}, ${monthYear.split(' ')[1]}`;
                }
              } else {
                // For single day events, show full date and time
                const utcDate = new Date(dateString);
                
                // Format using Intl.DateTimeFormat with UTC timezone to preserve the time as entered
                const formatter = new Intl.DateTimeFormat('en-US', {
                  weekday: 'long',
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: 'numeric',
                  minute: 'numeric',
                  timeZone: 'UTC',
                  hour12: true
                });
                
                return formatter.format(utcDate);
              }
            } catch (e) {
              console.error('Error formatting date:', e);
              return String(dateString);
            }
          };
          
          // Get start and end dates from the correct structure
          const startDate = data.dates && data.dates.start ? data.dates.start : '';
          const endDate = data.dates && data.dates.end ? data.dates.end : '';
          
          // Get content images
          const contentImages = data.content_images || [];
          
          return h('div', { className: 'bg-white' },
            // Header
            h('div', { className: 'bg-blue-100 border-b-4 border-blue-300 p-4 text-center' },
              h('h1', { className: 'text-2xl font-bold text-blue-800 mb-2' }, 'Event Preview'),
              h('div', { className: 'text-blue-700 max-w-3xl mx-auto' },
                h('p', { className: 'mb-2' }, 'Below you will see two views of your event. Note: Events only show if expiryDate is in the future.'),
                h('ol', { 
                  className: 'list-decimal list-inside text-left',
                  style: { listStyleType: 'decimal', paddingLeft: '1.5rem' }
                },
                  h('li', { className: 'mb-1' }, 'How your event will appear in the carousel on the homepage'),
                  h('li', { className: 'mb-1' }, 'How your event will appear on the events page')
                )
              )
            ),
            
            // Homepage Carousel View
            h('div', { className: 'bg-brand-light bg-opacity-80 py-8 mb-8' },
              h('div', { className: 'container mx-auto px-4' },
                h('div', { className: 'relative rounded-lg overflow-hidden shadow-lg event-card' },
                  h('div', { className: 'absolute inset-0' },
                    h('img', {
                      src: data.image ? this.props.getAsset(data.image).toString() : '',
                      alt: data.title || '',
                      className: 'w-full h-full object-cover'
                    }),
                    h('div', { className: 'absolute inset-0 bg-brand-dark bg-opacity-40' })
                  ),
                  h('div', { className: 'relative p-4 md:p-6 text-white event-content' },
                    h('div', { className: 'max-w-3xl mx-auto text-center flex flex-col h-full mt-4 md:mt-8' },
                      h('div', { className: 'flex-grow' },
                        h('h3', { className: 'text-2xl md:text-3xl hero-heading mb-3' }, data.title || ''),
                        h('div', { className: 'event-description' },
                          h('p', { className: 'text-base hero-tagline' }, data.description || '')
                        ),
                        h('p', { className: 'text-lg mb-4' },
                          h('span', { className: 'inline-block bg-brand-light text-brand-dark px-3 py-1 rounded-full' },
                            formatDate(startDate, endDate)
                          )
                        )
                      )
                    )
                  )
                )
              )
            ),
            
            // Event Content
            h('div', { className: 'container mx-auto px-4 py-8' },
              h('div', { className: 'grid grid-cols-1 md:grid-cols-5 gap-8' },
                // Event Details
                h('div', { className: 'md:col-span-2 event-details' },
                  // Title
                  h('h2', { className: 'text-brand-dark mb-2' }, data.title || 'Event Title'),
                  
                  // Date
                  h('div', { className: 'mb-4' },
                    h('span', { className: 'text-lg md:text-xl text-brand-dark hero-tagline' },
                      formatDate(startDate, endDate)
                    )
                  ),
                  
                  // Description
                  h('div', { className: 'prose max-w-none' },
                    data.description
                  )
                ),
                
                // Event Images
                contentImages.length > 0 ? 
                  h('div', { className: 'md:col-span-3 event-images' },
                    contentImages.map((image, index) => 
                      h('div', { key: index, className: 'mb-6' },
                        h('img', {
                          src: image.image ? this.props.getAsset(image.image).toString() : '',
                          alt: image.caption || 'Event Image',
                          className: 'w-full rounded-lg shadow-md'
                        }),
                        image.caption && h('p', { className: 'text-sm text-gray-600 mt-2 text-center' }, image.caption)
                      )
                    )
                  ) : 
                  data.image ? 
                    h('div', { className: 'md:col-span-3 event-images' },
                      h('div', { className: 'mb-6' },
                        h('img', {
                          src: this.props.getAsset(data.image).toString(),
                          alt: data.title || 'Event Image',
                          className: 'w-full rounded-lg shadow-md'
                        })
                      )
                    ) : null
              )
            )
          );
        }
      });
      
      // Register the Event Preview Template
      CMS.registerPreviewTemplate('events-items', EventPreview);
      
      // Events List Preview Component
      const EventsListPreview = createClass({
        getInitialState() {
          return { events: [] };
        },
        
        componentDidMount() {
          try {
            // Fetch events from the Events collection
            this.props.getCollection('events-items').then(events => {
              console.log('Events from getCollection:', events);
              
              const now = new Date();
              
              // Process events - filter out _index.md and expired events
              const processedEvents = events
                .filter(event => {
                  // Skip the _index.md file
                  const slug = event.get('slug');
                  if (slug === '' || slug === '_index') return false;
                  
                  // Get the data from the event
                  const eventData = event.get('data');
                  if (!eventData) return false;
                  
                  // Check expiry date
                  const expiryDate = eventData.expiryDate ? new Date(eventData.expiryDate) : null;
                  return expiryDate && expiryDate >= now;
                })
                .map(event => {
                  const data = event.get('data');
                  return {
                    ...data,
                    // Ensure dates are properly formatted
                    dates: {
                      start: data.dates?.start || null,
                      end: data.dates?.end || null
                    }
                  };
                });
              
              // Sort events by start date (ascending)
              processedEvents.sort((a, b) => {
                const aDate = a.dates && a.dates.start ? new Date(a.dates.start) : new Date(0);
                const bDate = b.dates && b.dates.start ? new Date(b.dates.start) : new Date(0);
                return aDate - bDate; // Ascending order
              });
              
              console.log('Processed events:', processedEvents);
              this.setState({ events: processedEvents });
            }).catch(error => {
              console.error('Error fetching events:', error);
            });
          } catch (error) {
            console.error('Error in componentDidMount:', error);
          }
        },
        
        render: function() {
          const entry = this.props.entry;
          const data = entry.getIn(['data']) ? entry.getIn(['data']).toJS() : {};
          const events = this.state.events;
          
          // Helper function to format dates
          const formatDate = function(dateString, endDateString) {
            if (!dateString) return 'Event Date';
            
            try {
              // If dateString is a Date object, get its ISO string
              if (typeof dateString === 'object' && dateString instanceof Date) {
                dateString = dateString.toISOString();
              }
              if (typeof endDateString === 'object' && endDateString instanceof Date) {
                endDateString = endDateString.toISOString();
              }
              
              // If we have both start and end dates, format as a range
              if (endDateString) {
                const startDate = new Date(dateString);
                const endDate = new Date(endDateString);
                
                // If dates are in different months or years, show full range
                const startYear = startDate.getUTCFullYear();
                const endYear = endDate.getUTCFullYear();
                const startMonth = startDate.toLocaleString('en-US', { month: 'long', timeZone: 'UTC' });
                const endMonth = endDate.toLocaleString('en-US', { month: 'long', timeZone: 'UTC' });
                
                if (startYear !== endYear) {
                  // Different years: "January 2, 2025 - January 3, 2026"
                  return `${startDate.toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC' })} - ${endDate.toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC' })}`;
                } else if (startMonth !== endMonth) {
                  // Same year, different months: "January 30 - February 3, 2025"
                  return `${startDate.toLocaleString('en-US', { month: 'long', day: 'numeric', timeZone: 'UTC' })} - ${endDate.toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC' })}`;
                } else {
                  // Same month and year: "January 1-5, 2025"
                  return `${startMonth} ${startDate.getUTCDate()}-${endDate.getUTCDate()}, ${startYear}`;
                }
              } else {
                // For single day events, show full date and time
                const utcDate = new Date(dateString);
                return `${utcDate.toLocaleString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC' })} at ${utcDate.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'UTC' })}`;
              }
            } catch (e) {
              console.error('Error formatting date:', e);
              return String(dateString);
            }
          };
          
          return h('div', { className: 'events-page bg-white' },
            // Hero Section
            data.featured_image ? 
              h('div', { className: 'relative h-48 md:h-64 overflow-hidden' },
                h('img', {
                  src: this.props.getAsset(data.featured_image).toString(),
                  alt: data.title || '',
                  className: 'absolute inset-0 w-full h-full object-cover'
                }),
                h('div', { className: 'absolute inset-0 bg-gray-900 bg-opacity-60' }),
                h('div', { className: 'absolute inset-0 flex items-center' },
                  h('div', { className: 'container mx-auto px-4' },
                    h('h1', { className: 'text-3xl md:text-4xl lg:text-5xl text-white mb-2 hero-heading' }, data.title || 'Events'),
                    data.tagline && h('p', { className: 'text-lg md:text-xl text-white opacity-90 hero-tagline' }, data.tagline)
                  )
                )
              ) :
              // Text-only header if no image
              h('div', { className: 'bg-white border-b' },
                h('div', { className: 'container mx-auto px-4 py-8' },
                  h('h1', { className: 'text-3xl md:text-4xl text-gray-900 hero-heading' }, data.title || 'Events'),
                  data.tagline && h('p', { className: 'text-lg md:text-xl text-gray-600 hero-tagline' }, data.tagline)
                )
              ),
            
            // Events List
            h('div', { className: 'container mx-auto px-4 py-12' },
              events.length > 0 ? 
                h('div', {},
                  events.map((event, index) => 
                    h('div', { key: index, className: 'grid grid-cols-1 md:grid-cols-5 gap-8 mb-16' },
                      // Event Details
                      h('div', { className: 'md:col-span-2 event-details' },
                        h('h2', { className: 'text-brand-dark mb-2' }, event.title || 'Event Title'),
                        h('div', { className: 'mb-4' },
                          h('span', { className: 'text-lg md:text-xl text-brand-dark hero-tagline' },
                            formatDate(event.dates?.start, event.dates?.end)
                          )
                        ),
                        h('div', { className: 'mb-4' },
                          h('p', { className: 'text-gray-700' }, event.description || '')
                        ),
                        event.content && h('div', { className: 'prose max-w-none' },
                          this.props.widgetFor('content')
                        )
                      ),
                      
                      // Event Images
                      h('div', { className: 'md:col-span-3 event-images' },
                        event.content_images && event.content_images.length > 0 ?
                          event.content_images.map((img, imgIndex) =>
                            h('div', { key: imgIndex, className: 'mb-6' },
                              h('img', {
                                src: this.props.getAsset(img.image).toString(),
                                alt: img.alt_text || event.title,
                                className: 'w-full rounded-lg shadow-md'
                              }),
                              img.caption && h('p', { className: 'text-sm text-gray-600 mt-2 text-center' }, img.caption)
                            )
                          ) :
                          event.image && h('div', { className: 'mb-6' },
                            h('img', {
                              src: this.props.getAsset(event.image).toString(),
                              alt: event.title,
                              className: 'w-full rounded-lg shadow-md'
                            })
                          )
                      )
                    )
                  )
                ) : 
                h('div', { className: 'text-center py-12' },
                  h('p', { className: 'text-xl text-gray-700' }, 'No upcoming events at this time.')
                )
            )
          );
        }
      });
      
      // Register the Events List Preview Template
      CMS.registerPreviewTemplate('events-index', EventsListPreview);
    </script>
</body>
</html> 